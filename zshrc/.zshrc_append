#!/bin/zsh

#===============================================================================
# plugin manager section
#===============================================================================
source "$HOME/.local/share/antigen/antigen.zsh"
antigen bundle zsh-users/zsh-autosuggestions
antigen bundle zsh-users/zsh-syntax-highlighting

# # Too slow to load
# antigen bundle marlonrichert/zsh-autocomplete
# antigen bundle zsh-users/zsh-completions
# antigen bundle agkozak/zsh-z

# # Even slower to load
# antigen use oh-my-zsh
# antigen theme robbyrussell
# antigen bundle git
# antigen bundle colored-man-pages

antigen apply


#===============================================================================
# Borrowed from other, check to make sure I understand
#===============================================================================
# some useful options (man zshoptions)
setopt autocd extendedglob nomatch menucomplete
setopt interactive_comments
stty stop undef		# Disable ctrl-s to freeze terminal.
zle_highlight=('paste:none')
# beeping is annoying
unsetopt BEEP
# completions
autoload -Uz compinit
zstyle ':completion:*' menu select
# zstyle ':completion::complete:lsof:*' menu yes select
zmodload zsh/complist
# compinit
_comp_options+=(globdots)		# Include hidden files.
autoload -U up-line-or-beginning-search
autoload -U down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search
# Colors
autoload -Uz colors && colors
bindkey "^p" up-line-or-beginning-search # Up
bindkey "^n" down-line-or-beginning-search # Down
bindkey "^k" up-line-or-beginning-search # Up
bindkey "^j" down-line-or-beginning-search # Down
autoload edit-command-line; zle -N edit-command-line
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000
SAVEHIST=1000
setopt INC_APPEND_HISTORY_TIME

#===============================================================================
# User configuration
#===============================================================================
# custom setup
. "$HOME/.shellfunc"
if [[ -d "$HOME/.vim/plugged/fzf" ]]; then
    addThisPath "$HOME/.vim/plugged/fzf/bin"
    . "$HOME/.vim/plugged/fzf/shell/completion.zsh"
    . "$HOME/.vim/plugged/fzf/shell/key-bindings.zsh"
fi
bindkey -v
if [[ -x "$HOME/.vim/plugged/fzf/bin/fzf" ]]; then
    addThisPath "$HOME/.vim/plugged/fzf/bin"
    if [[ -d "$HOME/.vim/plugged/fzf/shell" ]]; then
        for f in $(ls  "$HOME/.vim/plugged/fzf/shell/"*.zsh); do
            . "$f"
        done
    fi
    alias his='eval "$(history | tac | sed -n "s/[ 0-9]\+\(.*\)/\1/p" | fzf)"'
fi

eval "$(starship init zsh)"

# source asdf
. "$ASDF_DIR/asdf.sh"
. "$ASDF_DIR/completions/asdf.bash"

# refresh the ssh tty
# https://babushk.in/posts/renew-environment-tmux.html
if [ -n "$TMUX" ]; then
    function refresh {
        tmux_env="$(tmux show-environment)"
        new_ssh_tty="$(echo -n "$tmux_env" | grep '^SSH_TTY')"
        if [[ -n $new_ssh_tty ]]; then
            export "$new_ssh_tty"
        fi
    }
else
    function refresh { }
fi

function preexec {
    refresh
}

